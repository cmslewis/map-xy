<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="static/css/base.css">
  <link rel="stylesheet" type="text/css" href="static/css/flat.css">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
  <title>Map XY</title>
</head>
<body>
  <div class="header primary">
    How big is Location X compared to Location Y on a map?
  </div>
  <div class="panels">
    <div class="panel left">
      <div class="header secondary">
        <div class="search">
          <label>Location X:</label>
          <div class="input">
            <input type="text" tabindex="1" class="js-autocomplete-x" placeholder="Start typing then select a location...">
          </div>
        </div>
      </div>
      <div class="map js-map-x"></div>
    </div>
    <div class="panel right">
      <div class="header secondary">
        <div class="search">
          <label>Location Y:</label>
          <div class="input">
            <input type="text" tabindex="2" class="js-autocomplete-y" placeholder="Start typing then select another location...">
          </div>
        </div>
      </div>
      <div class="map js-map-y"></div>
    </div>
  </div>
  <div class="footer">
    <div class="footer-buttons">
      <div class="footer-button js-switch-maps-trigger">
        <div class="footer-button-content">
          <span class="footer-button-icon fa fa-arrows-h"></span>
          <span class="footer-button-label">Switch Maps</span>
        </div>
      </div>
      <div class="footer-button js-stacked-mode-trigger">
        <div class="footer-button-content show-by-default">
          <span class="footer-button-icon fa fa-copy"></span>
          <span class="footer-button-label">Stack Maps</span>
        </div>
        <div class="footer-button-content show-when-impressed">
          <span class="footer-button-icon fa fa-copy"></span>
          <span class="footer-button-label">Unstack Maps</span>
        </div>
      </div>
    </div>
    <span class="instructions">
      Explore each map independently. The zoom level will stay consistent between the two!
    </span>
  </div>

  <!-- Javascript -->
  <!-- ========== -->
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script type="text/javascript"
    src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyB8ych-xQPqDBlKWhIcbhp5fze4PWFfZwc">
  </script>
  <script type="text/javascript">

    var wasZoomChangeDoneProgrammatically = false;

    var KeyCodes = {
      TAB   : 9,
      ENTER : 13
    };

    var $ui = {
      panels             : $('.panels'),
      stackedModeTrigger : $('.js-stacked-mode-trigger'),
      switchMapsTrigger  : $('.js-switch-maps-trigger'),
      mapX               : $('.js-map-x'),
      mapY               : $('.js-map-y'),
      autocompleteX      : $('.js-autocomplete-x'),
      autocompleteY      : $('.js-autocomplete-y'),
      autocompleteFields : $('.search input'),
      autocompleteLabels : $('.search label')
    };

    function initialize() {
      maps = initializeMaps();

      mapX = maps[0]
      mapY = maps[1]

      initializeButtons(mapX, mapY);
      initializeSearch(mapX, $ui.autocompleteX, $ui.autocompleteY);
      initializeSearch(mapY, $ui.autocompleteY, $ui.autocompleteX);

      $ui.autocompleteX.focus();
    }

    function propagateZoomLevel(fromMap, toMap) {
      google.maps.event.addListener(fromMap, 'zoom_changed', function() {

        if (wasZoomChangeDoneProgrammatically) {

          // Do nothing, just reset the variable.
          wasZoomChangeDoneProgrammatically = false;

        } else {

          // Change the zoom level in the other map. Be sure to set the flag before changing the zoom of the other map,
          // because this listener will be fired immediately after the other map's zoom level changes.
          wasZoomChangeDoneProgrammatically = true;
          toMap.setZoom(fromMap.getZoom());

        }
      });
    }

    function initializeMaps() {
      var mapOptions = {

        // Basic Options

        center : { lat: -34.397, lng: 150.644 },
        zoom   : 8,

        // Enabled Controls

        scaleControl : true,

        // Disabled Controls

        mapTypeControl     : false,
        panControl         : false,
        overviewMapControl : false,
        streetViewControl  : false,
        zoomControl        : false

      };

      var mapX = new google.maps.Map($ui.mapX[0], mapOptions);
      var mapY = new google.maps.Map($ui.mapY[0], mapOptions);

      propagateZoomLevel(mapX, mapY);
      propagateZoomLevel(mapY, mapX);

      return [mapX, mapY];
    }

    function initializeSearch(map, $input, $nextInput) {
      var autocomplete = new google.maps.places.Autocomplete($input[0]);
      autocomplete.bindTo('bounds', map);

      // We only want to search for coarse, geocode-able locations; not businesses, landmarks, and other small stuff.
      autocomplete.setTypes(['geocode']);

      google.maps.event.addListener(autocomplete, 'place_changed', function() {
        var place = autocomplete.getPlace();

        if (!place.geometry) {
          return;
        }

        // If the place has a geometry, then present it on a map.
        if (place.geometry.viewport) {
          map.fitBounds(place.geometry.viewport);
        } else {
          map.setCenter(place.geometry.location);
        }

        // Automatically focus on the other search field.
        $input.blur();
        $nextInput.focus();
      });
    }

    function initializeButtons(mapX, mapY) {

      $ui.stackedModeTrigger.on('click', function() {
        if ($ui.panels.attr('data-view-mode') === 'stacked') {
          $ui.panels.attr('data-view-mode', '');
          $(this).removeClass('is-impressed');
        } else {
          $ui.panels.attr('data-view-mode', 'stacked');
          $(this).addClass('is-impressed');
        }

        // We need to let the Maps API know when the size of the Map X container changes.
        google.maps.event.trigger(mapX, 'resize');
      });

      $ui.switchMapsTrigger.on('click', function() {
        var newMapXCenter = mapY.getCenter();
        var newMapYCenter = mapX.getCenter();
        mapX.panTo(newMapXCenter);
        mapY.panTo(newMapYCenter);

        var newAutocompleteXText = $ui.autocompleteY.val();
        var newAutocompleteYText = $ui.autocompleteX.val();
        $ui.autocompleteX.val(newAutocompleteXText);
        $ui.autocompleteY.val(newAutocompleteYText);
      });

      $ui.autocompleteFields.on('focus', function() {
        $(this).closest('.input').addClass('focus');
      });

      $ui.autocompleteFields.on('blur', function() {
        $(this).closest('.input').removeClass('focus');
      });

      $ui.autocompleteLabels.on('click', function() {
        $ui.autocompleteFields.blur();
        $(this).siblings('.input').find('input').focus();
      });

      $ui.autocompleteX.on('keyup', function(ev) {
        if (ev.keyCode == KeyCodes.ENTER) {
          console.log('enter in input x');

        }
      });

      // Some elements within the maps are visible in the tabbing order. This ensures that tabbing only toggles focus
      // between the two search fields.
      $ui.autocompleteY.on('keydown', function(ev) {
        if (ev.keyCode == KeyCodes.TAB) {
          ev.preventDefault();
          $(this).blur();
          $ui.autocompleteX.focus();
        }
      });
    }

    google.maps.event.addDomListener(window, 'load', initialize);

  </script>
</body>
</html>
